version: '3.11'

volumes:
    mariadb:

services:
    gateway:
        image: krakenstdio/k-api-gateway:latest
        command: sh -c 'uvicorn main:app --reload --host 0.0.0.0'
        build:
            context: ./gateway
            dockerfile: Dockerfile
        env_file:
            - ./gateway/.env
        ports:
          - 8001:8000
        depends_on:
          - users        
        volumes:
          - ./gateway:/app

    users:
        image: krakenstdio/k-users:latest
        command: sh -c 'uvicorn main:app --reload --host 0.0.0.0'
        build:
            context: ./users
            dockerfile: Dockerfile
        depends_on:
            - db
        env_file:
            - ./users/.env
        volumes:
          - ./users:/app

    db:
        image: mariadb
        restart: always
        ports: 
            - 3307:3306
        
        env_file:
            - ./db/.env
    
        environment:
            -MYSQL_ROOT_PASSWORD : '$MYSQL_ROOT_PASSWORD'
            -MYSQL_DATABASE: '$MYSQL_DATABASE'
            -MYSQL_USER: '$MYSQL_USER'
            -MYSQL_PASSWORD: '$MYSQL_PASSWORD'

        volumes:
            - mariadb:/var/lib/mysql
            #Todo fix load init script    
            - ./db/data/initial_script.sql:/docker-entrypoint-initdb.d/initial_script.sql:ro            
